<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Savannah-Chatham Restaurant Inspections</title>
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="../img/favicon.ico" />
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/ny_licenses.css" rel="stylesheet">
    <link href='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.css' rel='stylesheet' />
    <style>body,html {width:100%; height:100%; margin:0; padding:0; overflow:hidden;} #map_canvas {position:absolute; top:40px; left:0; right:0; bottom:0;}</style>
    <link rel="stylesheet" href="css/leaflet.css" />
    <!--[if IE]><link rel="stylesheet" href="../css/leaflet.ie.css" /><![endif]-->
    <link  href="css/cartodb-leaflet.css" rel="stylesheet" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
    <script src="js/leaflet.js"></script>
    <script type="text/javascript" src="js/wax.leaf.min.js"></script>

    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />




    <script type="text/javascript" src="dist/cartodb-leaflet-min.js"></script>
    <script type="text/javascript" src="dist/cartodb-popup-min.js"></script>
  <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
  <script type='text/javascript' src='https://www.google.com/jsapi'></script>

<script type="text/javascript">
$('a').each(function() {

   var a = new RegExp('/' + window.location.host + '/');
   if(!a.test(this.href)) {
       $(this).click(function(event) {
           event.preventDefault();
           event.stopPropagation();
           window.open(this.href, '_blank');
       });
   }
});</script>

    <script type="text/javascript">
      var licenses, map;

      function initialize() {


        //add base layer
        map = new L.Map('map_canvas').setView(new L.LatLng(-75.28, 42.74), 11);

        var mapboxUrl = 'https://a.tiles.mapbox.com/v4/junipertcy.ml1j80fa/page.html?access_token=pk.eyJ1IjoianVuaXBlcnRjeSIsImEiOiJvOFg5WFVjIn0.7NDB1oOLpq3A5qO7vLaQSA',
            mapbox = new L.TileLayer(mapboxUrl, {maxZoom: 14, attribution:"Powered by Leaflet and Mapbox"});
        map.addLayer(mapbox,true);

        var query="SELECT * FROM test_3";

          var popup = new L.CartoDBPopup();
          var circleMarker = {};
          var hover_style = {radius:4, color:"#000", weight:1, opacity:1, fillColor: "#FFFFFF", fillOpacity:0.5, clickable:false};

        console.log('hello1');

        // create a layer with 1 sublayer
        var licensed =cartodb.createLayer(map, {
          user_name: 'junipertcy'
        });











        licenses = new L.CartoDBLayer({
          map: map,
          user_name:'junipertcy',
          extra_params:{v:2},
          table_name: 'test_3',
          query: query,
          interactivity: "cartodb_id,the_geom,count,type",
          featureOver: function(ev,latlng,pos,data) {
            document.body.style.cursor = "pointer";
            showTooltip(data,pos)

            // Show the hover point if it is a different feature
            if (data.cartodb_id != circleMarker.cartodb_id) {
              map.removeLayer(circleMarker);

              circleMarker = new L.CircleMarker(new L.LatLng(data.lat, data.lng), hover_style);
              circleMarker.cartodb_id = data.cartodb_id;

              map.addLayer(circleMarker);
            }

          },
          featureOut: function() {
            document.body.style.cursor = "default";
            hideTooltip();

            // Hide and remove in any case the hover point
            circleMarker.cartodb_id = null;
            map.removeLayer(circleMarker)
          },
          featureClick: function(ev,latlng,pos,data) {
              window.open(data["link"],"_blank");

          },
          auto_bound: false
        });



        console.log('hello2');

        console.log(data);


        map.addLayer(licenses)
      }

      function showTooltip(data,point) {
        var html = "";

        var name = (data["site_name"]!="")?data["site_name"]:"Unknown";
        html += "<label>Name</label><p>" + name +"</p>";html += "<label>Address</label><p>" + data["address"] +"</p>";
        html += "<label>Grade</label><p>" + getLicenseCategoryName(data["gradecat"]) +"</p>";
        html += "<label>Score</label>" + data["score"] +"</p>";
        html += "<br><a href='" + data["link"] +"' target='_blank'>Click for more</a>";

        $("#tooltip").html(html);
        $("#tooltip").css({left: (point.x + 15) + 'px', top: point.y - ($("#tooltip").height()) + 10 + 'px'})
        $("#tooltip").show();
      }

      function hideTooltip() {
        $("#tooltip").hide();
      }

      function getLicenseCategoryName(gradecat) {
          if (gradecat=='1')
              return "A";
          if (gradecat=='2')
              return "B";
          if (gradecat=='3')
              return "C";
      }


      function changeLayer(layer) {
          if (layer == 'All') {
              licenses.setQuery("SELECT *,ST_X(the_geom) as lng,ST_Y(the_geom) as lat FROM savchat4 ORDER BY random()");
          } else if (layer == 'A') {
              licenses.setQuery("SELECT *,ST_X(the_geom) as lng,ST_Y(the_geom) as lat FROM savchat4 WHERE gradecat='1'");
          } else if (layer == 'B') {
              licenses.setQuery("SELECT *,ST_X(the_geom) as lng,ST_Y(the_geom) as lat FROM savchat4 WHERE gradecat='2'");
          } else if (layer == 'C') {
              licenses.setQuery("SELECT *,ST_X(the_geom) as lng,ST_Y(the_geom) as lat FROM savchat4 WHERE gradecat='3'");
          }
      }

  // BEGIN GEOCODING
  var geocoder;
  geocoder = new google.maps.Geocoder();
  var firstRun = true;
  var markerGroup;
  function geoCode(address){
    geocoder.geocode( { 'address': address}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
      var lat = results[0].geometry.location.lat();
      var lng = results[0].geometry.location.lng();
      var latLng = new L.LatLng(lat, lng);
      map.panTo(latLng);
      // Set the zoom to whatever you want.
      // the higher the number the greater the zoom.
      map.setZoom(15);


      // Optional, drop marker
      if (firstRun == false){
        map.removeLayer(markerGroup)
      }
      var marker = L.marker([lat, lng]);
      markerGroup = L.layerGroup([marker]);
      map.addLayer(markerGroup);
      firstRun = false;

        } else {
        }
      });
  }
  // It wasn't recognizing this without wrapping it in jquery ready
  $(document).ready(function() {
    $('#btnGeocode').click(function(){
      var addrs = $('#txtGeocode').val();
      geoCode(addrs);
    });
    $(document).keydown(function(e) {
      if (e.keyCode==13) { // return key
          $('#btnGeocode').trigger('click');
        }
    });
  });



    </script>
  </head>
  <body onload="initialize()">

    <div id="map_canvas"></div>

</div>


    <div class="alert alert-info" id="legend"> <div style="margin-left: -12px; margin-top:5px;">
    <a href="http://savannahnow.com" target="_blank"><img src="img/title.png" /></a></div><div id="about">
 <p><b>  Savannah-Chatham Restaurant Inspections Database</b></p><div id="info">
Data: <a href="http://ga.state.gegov.com/georgia/search.cfm?county=Chatham" target="_blank">Chatham County Health Department</a> | <a href="about.html" onclick="window.open('about.html','popup','width=500,height=500,scrollbars=no,resizable=no,toolbar=no,directories=no,location=no,menubar=no,status=no,left=0,top=0'); return false">About this Map</a></div></div><div style="margin-top:5px;margin-bottom:10px;margin-left:12px;color:#000">

<em>Hover over the locations to see inspection details, or drill down by either address or score below</em></div><div style="margin-bottom:7px;margin-left:12px;">
                        <label for="txtGeocode">
                            Search by address:</label>
                        <input id="txtGeocode" type="text" />
                        <input id="btnGeocode" type="button" value="Find" />
                    </div>

<div style="float:center; display: none;"></div><div class="filter">Filter by score:</div>
    <div class="btn-group">
            <button class="btn" onClick="changeLayer('All')">All Scores</button>
            <button class="btn" onClick="changeLayer('A')"><img src="img/blue.png" width="12" height="12" />A (90-100)</button>
            <button class="btn" onClick="changeLayer('B')"><img src="img/green.png" width="12" height="12"  />B (80-89)</button>
            <button class="btn" onClick="changeLayer('C')"><img src="img/yellow.png" width="12" height="12"  />C (71-80)</button>

          </div>

<div id="copyright">Â© 2015 <a href="http://savannahnow.com" target="_blank">Savannah Morning News</a> - By <a href="http://twitter.com/carlvlewis">Carl V. Lewis.</a></div>

    </div>

    <div class="alert alert-info" id="tooltip">
      <p>Tooltip</p>
    </div>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/bootstrap-tab.js"></script>
    <script src="js/bootstrap-tooltip.js"></script>


<script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>



<script type="text/javascript">
$('a').each(function() {
   var a = new RegExp('/' + window.location.host + '/');
   if(!a.test(this.href)) {
       $(this).click(function(event) {
           event.preventDefault();
           event.stopPropagation();
           window.open(this.href, '_blank');
       });
   }
});</script>
  </body>
</html>

