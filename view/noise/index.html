<!DOCTYPE html>
<html lang="en">
  <head>
    <title>ACMMM 2015 | IBM New York City 360 DEMO</title>
    <meta name="description" content="New York City Noise Diagnotor - part of the urban-walkability project">
    <meta name="author" content="">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>

<!-- pace --//在讀取圖片放，在首頁放，其他都不放
    <script src="bower_components/pace/pace.js"></script>
    <link href="bower_components/pace/themes/blue/pace-theme-loading-bar.css" rel="stylesheet" />
<!-- left -->
    <link rel="shortcut icon" href="http://cartodb.com/assets/favicon.ico" />
    <link href="bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="bower_components/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet">
    <link href="bower_components/cartodb.js/themes/css/cartodb.css" rel="stylesheet">
    <link href="bower_components/jcarousel/examples/data-attributes/jcarousel.data-attributes.css" rel="stylesheet">
    <link href="bower_components/jquery-menu/src/css/jquery.menu.css" rel="stylesheet">
    <link href="bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <link href="bower_components/mapbox.js/mapbox.css" rel="stylesheet">
    <script src="bower_components/mapbox.js/mapbox.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
    <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script type='text/javascript' src='https://www.google.com/jsapi'></script>


    <link href="plugins/css/ny_licenses.css" rel="stylesheet">
    <link href="plugins/css/map.css" rel="stylesheet">
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
  </head>


  <body>
  <!-- for mapbox infowindow -->
    <script src="node_modules/pleasejs/dist/Please.js"></script>
    <script src='node_modules/linkurious/dist/sigma.min.js'></script>
    <script src='node_modules/linkurious/dist/plugins.min.js'></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.js"></script>


    <script src="bower_components/highcharts/highcharts.js"></script>
    <script src="bower_components/highcharts/highcharts-more.js"></script>
    <script src="bower_components/highcharts/modules/exporting.js"></script>

    <script src="plugins/js/tools.js"></script>
    <script src="plugins/js/customInfowindow.js"></script>
    <script src="plugins/js/drawChart.js"></script>
    <script src="plugins/js/drawMap.js"></script>
    <script src="plugins/js/drawNetwork.js"></script>
    <script src="bower_components/jquery-menu/src/js/jquery.menu.js"></script>
    <script src="bower_components/cartodb.js/cartodb.js"></script>
  <!-- -->

    <div id="map">



    <script>
      'use strict';
      var layerInit, custom_infowindow, sql, clickRetData, seasonParam, subLayer, ctInfowindowGlobal, showLayer;
      function main(season) {
        var seasonName;
        if (season === 0) {
          seasonName = 'spring';
        } else if (season === 1) {
          seasonName = 'summer';
        } else if (season === 2) {
          seasonName = 'fall';
        } else if (season === 3) {
          seasonName = 'winter';
        }

        cartodb.createVis('map', 'https://junipertcy.cartodb.com/api/v2/viz/ff9fb71c-74d6-11e5-95f0-0e787de82d45/viz.json', {
          tiles_loader: true,
          center_lat: 40.6941,
          center_lon: -73.8758,
          zoom: 11,
          infowindow: true
        }).done(function(vis, layers) {
          var map = vis.getNativeMap();
          // It wasn't recognizing this without wrapping it in jquery ready
          $(document).ready(function() {
            $('#btnGeocode').click(function(){
              var addrs = $('#txtGeocode').val();
              geocodeAddress(addrs, map);
            });
            $(document).keydown(function(e) {
              if (e.keyCode==13) { // return key
                  $('#btnGeocode').trigger('click');
                }
            });
          });

          //data layer
          layerInit = layers[1];

          subLayer = layerInit.getSubLayers();

          // subLayer.forEach(function(i) {
          //   i.hide();
          // });

          subLayer[season].show();
          var data = {};
          data.cartodb_id = 0;

          infoWindow([40.733, -73.893], function(err, ctInfoWindow){
            //An initialization
            for (var s = 0; s <= 3; s++) {
              subLayer[s].infowindow.set({
                template: ctInfoWindow,
                sanitizeTemplate: true,
                width: 400,
                maxHeight: 700
              });
            }

            showLayer = function (layerToShow) {
              var layer = layerInit.getSubLayers();
              var season;
              //turn off all layer
              layer.forEach(function(i) {
                i.hide();
              });
              switch (layerToShow) {
                case 'Z':
                  seasonParam = 0;
                  layer[0].show();
                  layer[0].infowindow.set('template', ctInfowindowGlobal);
                  layer[0].setInteraction(true)
                  fetchChartDataAndDraw(null, clickRetData.cartodb_id);
                  break;
                case 'A':
                  seasonParam = 0;
                  layer[0].infowindow.set('template', ctInfowindowGlobal);
                  layer[0].setInteraction(true)
                  layer[0].show();
                  fetchChartDataAndDraw('spring', clickRetData.cartodb_id, 0);
                  break;
                case 'B':
                  seasonParam = 1;
                  layer[1].infowindow.set('template', ctInfowindowGlobal);
                  layer[1].setInteraction(true)
                  layer[1].show();
                  fetchChartDataAndDraw('summer', clickRetData.cartodb_id, 1);
                  break;
                case 'C':
                  seasonParam = 2;
                  layer[2].infowindow.set('template', ctInfowindowGlobal);
                  layer[2].setInteraction(true)
                  layer[2].show();
                  fetchChartDataAndDraw('fall', clickRetData.cartodb_id, 2);
                  break;
                case 'D':
                  seasonParam = 3;
                  layer[3].infowindow.set('template', ctInfowindowGlobal);
                  layer[3].setInteraction(true)
                  layer[3].show();
                  fetchChartDataAndDraw('winter', clickRetData.cartodb_id, 3);
                  break;
              }
              return season;
            };
            // for (var s = 0; s <= 3; s++) {
            //   subLayer[0].infowindow.set({
            //     template: ctInfowindowGlobal,
            //     sanitizeTemplate: true,
            //     width: 400,
            //     maxHeight: 700
            //   });
            // }
          });

          layerInit.on('featureClick', function(e, latlng, pos, data) {
            clickRetData = data;
            infoWindow(latlng, function(err, ctInfoWindow){
              ctInfowindowGlobal = ctInfoWindow;

              if (!!seasonParam === false) {
                subLayer[0].infowindow.set('template', ctInfowindowGlobal);
              } else {
                subLayer[seasonParam].infowindow.set('template', ctInfowindowGlobal);
              }

              fetchChartDataAndDraw(null, data.cartodb_id, null);
              if (seasonParam === 0) {
                fetchChartDataAndDraw('spring', clickRetData.cartodb_id, 0);
              } else if (seasonParam === 1) {
                fetchChartDataAndDraw('summer', clickRetData.cartodb_id, 1);
              } else if (seasonParam === 2) {
                fetchChartDataAndDraw('fall', clickRetData.cartodb_id, 2);
              } else if (seasonParam === 3) {
                fetchChartDataAndDraw('winter', clickRetData.cartodb_id, 3);
              }
            });
          });


        }).error(function(err){
          console.log('Layer loading error!');
          console.log(err);
        });
      }

  // BEGIN GEOCODING
  var marker = L.marker();
  var firstRun = true;
  function geocodeAddress(address, resultsMap){
    var geocoder = new google.maps.Geocoder();

    geocoder.geocode({
      address: address,
      componentRestrictions: {
        country: 'US',
        locality: 'New York City'
      }
    }, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        var lat = results[0].geometry.location.lat();
        var lng = results[0].geometry.location.lng();
        //Show: the place you requested is at ...
        console.log('The place you requested is at ...');
        console.log(lat, lng);
        if (firstRun === true) {
          marker = L.marker([lat, lng]).addTo(resultsMap);
        } else {
          var newLatLng = new L.LatLng(lat, lng);
          marker.setLatLng(newLatLng);
        }
        //resultsMap.setView([lat, lng], 14);
        firstRun = false;
      } else {
        alert('Geocode was not successful due to the following reason: ', status);
      }
    });
  }




    var fetchChartDataAndDraw = function (seasonName, id, season) {
      sql = new cartodb.SQL({
        user: 'junipertcy'
      });

      sql.execute('SELECT * FROM z_5 WHERE cartodb_id = ' + id).done(function(yearData){
        var i = yearData.rows[0];
        if (i) {
          var gridYear = [i.loud_music_party, i.vehicle, i.construction, i.banging_pounding, i.ac_ventolation, i.loud_talking, i.manufacturing, i.alarms, i.others];
          gridYear = toPercent(gridYear);
        }
        //Select seasonal data
        if (!!seasonName === false) {
          draw_chart(gridYear);
        } else {
          sql.execute('SELECT * FROM ' + seasonName  + ' WHERE cartodb_id = ' + id).done(function(seasonData){
            var i = seasonData.rows[0];
            if (i) {
              var gridSeason = [i.loud_music_party, i.vehicle, i.construction, i.banging_pounding, i.ac_ventolation, i.loud_talking, i.manufacturing, i.alarms, i.others];
              gridSeason = toPercent(gridSeason);
              draw_chart(gridYear, gridSeason, season);
            }
          });
        }
      });
    };

    window.onload = main(0);

    </script>


    <div class="alert alert-info" id="legend">

    <div style="margin-left: 0px; margin-top:0px;">
      <h4>
        <a href="./" target="_blank"><img src="img/logo.png"/></a>
      </h4>
    </div>

    <div id="about">
      <h4 font-family:"Helvetica"; color:"green"><br>MM-15 Grand Challenge DEMO: <br>Reasoning Urban Noises from Multimodal <br>Geo-Social Media Data</h4><div id="info">
      <h5><br>Data: <a href="https://nycopendata.socrata.com/Social-Services/311-Service-Requests-from-2010-to-Present/erm2-nwe9" target="_blank">NYC 311 Service Requests Database</a>, <a href="https://developer.foursquare.com/" target="_blank">Foursquare API</a>, <a href="https://www.flickr.com/services/api/" target="_blank">Flickr API</a>, <a href="https://snap.stanford.edu/data/loc-gowalla.html" target="_blank">SNAP-Gowalla</a> and <a href="https://dev.twitter.com" target="_blank">Twitter API</a></h5>
      </div></div><div style="margin-top:5px;margin-bottom:10px;margin-left:12px;color:#000">
      <em>Click over the locations to see noise details.</em>
    </div>
    <div style="margin-bottom:7px;margin-left:12px;">
      <label for="txtGeocode">
      Search by address:</label>
      <input id="txtGeocode" type="text" />
      <input id="btnGeocode" type="button" value="Find" />
    </div>

    <div style="float:center; display: none;"></div>
    <div class="filter">Filter by seasons:</div>

    <div class="btn-group">
      <button class="btn btn-default" onClick="showLayer('Z')">All</button>
      <button class="btn btn-default" onClick="showLayer('A')"><img src="img/red.png" width="11" height="12" /> Spring</button>
      <button class="btn btn-default" onClick="showLayer('B')"><img src="img/green.png" width="11" height="12" /> Summer</button>
      <button class="btn btn-default" onClick="showLayer('C')"><img src="img/yellow.png" width="11" height="12" /> Fall</button>
      <button class="btn btn-default" onClick="showLayer('D')"><img src="img/blue.png" width="11" height="12" /> Winter</button>
    </div>
      <div id="copyright">© 2015 <a href="http://mslab.csie.ntu.edu.tw/~sandoh/">Hsun-Ping Hsieh</a>, <a href="http://junipertcy.info">Tzu-Chi Yen</a> and <a href="http://www.citi.sinica.edu.tw/pages/ctli/index_en.html">Cheng-Te Li</a>
      </div>
    </div>

  </body>
</html>